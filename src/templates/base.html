<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>People Count | KDS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    </head>
  <body>
  <section class="section">
    <div class="container">
        <div class="columns">
            <div class="column is-narrow">
              <div class="box" style="width: 700px;">
                <p class="title is-5">In/Out Chart</p>
                <hr>
                <div>
                  <canvas id="myChart"></canvas>
                </div>
              

              </div>
            </div>
            <div class="column">
                <div class="box">
                    <p class="title is-5">Stream</p>
                    <input class="input" id="channel-id" type="text">
                    <br><br>
                    <span>
                      <button onclick="start()" type="button" id="start" class="button is-primary">Start</button>
                      <!-- <button type="button" id="stopButton" class="button is-danger">Stop</button> -->
                    </span>
                    
                    <hr>
                    <img id="frame" src="">
                    <div id="textArea"></div>


                    <script>
                      function start(){
                        // Chart.js Bar chart plot Configs
                        const ctx = document.getElementById('myChart');
                        const barChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                              labels: ['IN', 'OUT'],
                              datasets: [{
                                data: [0, 0],
                                borderWidth: 1,
                                backgroundColor: [
                                  'rgba(54, 162, 235, 0.5)',
                                  'rgba(255, 99, 0, 0.5)'
                                ]
                              }]
                            },
                            options: {
                              legend: {display: false},
                              scales: {
                                y: {
                                  beginAtZero: true
                                }
                              }
                            }
                          });

                        channel_id = document.getElementById("channel-id").value
                        let ws = new WebSocket(`ws://0.0.0.0:8000/get-stream/${channel_id}`);
                        console.log("WebSocket connection opened.");


                        let image = document.getElementById("frame");
                        image.onload = function(){
                            URL.revokeObjectURL(this.src); // release the blob URL once the image is loaded
                        } 



                        ws.onmessage = function(event) {
                            if (typeof event.data === 'string'){
                                // split by comma
                                // document.getElementById("textArea").innerHTML = event.data.split(',')[0];
                                inCount = event.data.split(',')[0];
                                outCount = event.data.split(',')[1];
                                console.log(event.data.split(',')[0], event.data.split(',')[1]); 
                                barChart.data.datasets[0].data = [inCount, outCount];
                                barChart.update(); 
                                // document.getElementById("textArea").innerHTML = event.data;
                              }
                            else{
                                image.src = URL.createObjectURL(event.data);
                            }
                        };

                        const stopButton = document.getElementById("stopButton");
                        stopButton.addEventListener("click", function() {
                            ws.send("stop");
                            // ws.close(); // Close the WebSocket connection
                            console.log("WebSocket connection closed.");
                        });
                      };

                      

                    </script>


                </div>
            </div>
          </div>
    </div>
  </section>
  </body>
</html>